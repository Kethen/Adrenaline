set -xe

project_pwd=$(pwd)
project_pwd=$(realpath "$project_pwd")

cp procfw_sdk_prebuilt/include/* /usr/local/pspdev/psp/sdk/include/
cp procfw_sdk_prebuilt/lib/* /usr/local/pspdev/psp/sdk/lib/

cd cef/ge_peek
make clean
make
cd "$project_pwd"

cp cef/ge_peek/ge_peek.prx user/flash0/kd/ge_peek.prx

cd cef/btcnf/pspbtcnf_inferno
btcnf build pspbtcnf.txt
cd "$project_pwd"

cp cef/btcnf/pspbtcnf_inferno/pspbtcnf.bin user/flash0/kd/pspbtknf.bin

cd cef/inferno
make clean
make
cd "$project_pwd"

cp cef/inferno/inferno.prx user/flash0/kd/inferno.prx

if false
then
    cd cef/systemctrl
    make clean
    make
    cd "$project_pwd"

    cp cef/systemctrl/systemctrl.prx user/flash0/kd/systemctrl.prx
fi

rm -rf kernel_build
mkdir -p kernel_build
cd kernel_build
cmake ../kernel
make

cp libAdrenalineKernel_stub.a /usr/local/vitasdk/arm-vita-eabi/lib/
cp libAdrenalineKernel_stub_weak.a /usr/local/vitasdk/arm-vita-eabi/lib/

cd "$project_pwd"

if ! [ -e vita2dlib ]
then
    git clone https://github.com/frangarcj/vita2dlib.git -b fbo
fi
cd vita2dlib/libvita2d
make clean
make
cp libvita2d.a /usr/local/vitasdk/arm-vita-eabi/lib/libvita2d.a
cp include/vita2d.h /usr/local/vitasdk/arm-vita-eabi/include/vita2d.h

cd "$project_pwd"

if ! [ -e vita-shader-collection.tar.gz ]
then
    wget https://github.com/frangarcj/vita-shader-collection/releases/download/master-0.1-v86/vita-shader-collection.tar.gz
fi
tar -C /usr/local/vitasdk/arm-vita-eabi -xvf vita-shader-collection.tar.gz

cd "$project_pwd"

rm -rf user_build
mkdir -p user_build
cd user_build
cmake ../user
make

cd "$project_pwd"

rm -rf vsh_build
mkdir -p vsh_build
cd vsh_build
cmake ../vsh
make

cd "$project_pwd"

cp user_build/adrenaline_user.suprx bubble/pkg/sce_module/adrenaline_user.suprx
cp vsh_build/adrenaline_vsh.suprx bubble/pkg/sce_module/adrenaline_vsh.suprx
cp kernel_build/adrenaline_kernel.skprx bubble/pkg/sce_module/adrenaline_kernel.skprx

rm -rf bubble_build
mkdir -p bubble_build
cd bubble_build
cmake ../bubble
make

